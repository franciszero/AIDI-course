(window.webpackJsonp=window.webpackJsonp||[]).push([[48],{n0mJ:function(e,t,o){"use strict";o.d(t,"a",(function(){return f}));var n=o("Llzl"),i=o("Oyr+"),r=o("nYZ0"),s=o("A+IJ"),d=o("lr7J"),l=o("pjml"),a=o("IbyE"),h=o("6fZB"),c=o("zGdY"),p=o("Sa5G"),u=o("W6wm");class I{constructor(e,t,o,n,s,d,a,c,I,f,C,g,m,v,$,N){this.$scope=e,this.CourseModel=t,this.CourseContentModel=o,this.contextCourse=n,this.contentService=s,this.rootNodeType=d,this.contextAreaName=a,this.allyService=c,this.bbLocalize=I,this.interval=f,this.ultraState=C,this.accessibility=g,this.$ngRedux=m,this.$q=v,this.gradableItemUserOptionService=$,this.entitlementService=N,this.CONTENT_LOADING_LIMIT=10,this.contentLoadInProgress=!1,this.canMove=!1,this.dropTargetAssignedFromButton=!1,this.hasNetworkError=!1,this.syllabusKey="syllabusKey",this.loadSingleContent=e=>this.contentService.findContentItem(this.$scope.course.model,e).$then((e=>{e.$scope=this.rootNode.children,this.rootNode.children.push(e),this._determineHasMoreChildren(this.rootNode,this.rootNode.children.length),this.contentLoadInProgress=!1,this.replaceDueDate(this.rootNode.children),this.recalculateEmptyState(),this.contentService.fetchIndicators(this.contextCourse.courseId).then((e=>{this.updateIndicators(e,this.rootNode)}))})),this.loadMoreChildren=(e,t=!0)=>this._loadMoreChildren(e,t),this.deleteContentItem=(e,t=!0)=>{this.rootNode&&this.rootNode.children?this.rootNode.children.$then((()=>{this.handleCourseLinksInOutline(e,this.rootNode),this.cachedNode=this.rootNode.findInTreeById(e.parentId,this.cachedNode),this.deleteNode(e,this.cachedNode,t)})):this.deleteNode(e,null,t)},this.createEmptyFolder=(e,t)=>{const{Folder:o}=l.p.ContentHandler;return this.allyService.fileUploadEvent(),Object(h.a)(this.contentService.makeContentInContentTree(this.rootNode,this.contextCourse.courseId,t.parentId,t.positionBefore,t.positionAfter,!0).then((n=>{const i=n.content;return i.title=e,this.fillInDetailsForUploadedContent(i,t),i.contentDetail={[o.toString()]:{isFolder:!0}},i.contentHandler=o,i.$save().$then((e=>{e.ui.isUploading=!1})).$asPromise()})))},this.moveItemIntoFolder=e=>{const t=this._findNodeByIdFromParentNode(this.rootNode,e.dragContentId),o=this._findNodeByIdFromParentNode(this.rootNode,e.targetFolderId);e.originalElement.hide();const n=this.loadMoreChildren(o);if(l.p.ContentHandler.LearningModule.isEqualTo(t.contentHandler)&&(l.p.ContentHandler.Folder.isEqualTo(o.contentHandler)||l.p.ContentHandler.LearningModule.isEqualTo(o.contentHandler)))return this.moveError("course.outline.lmMoveError"),n.$then((()=>{e.originalElement.show()}));if(l.p.ContentHandler.Folder.isEqualTo(t.contentHandler)&&l.p.ContentHandler.LearningModule.isEqualTo(o.contentHandler)){if(!t.children)return t.getChildren({limit:0}).$asPromise().then((i=>i.some((e=>e.isUiFolder()))?(this.moveError("course.outline.lmMoveFolderError"),n.$then((()=>{e.originalElement.show()}))):n.$then((()=>{this.doMoveItemFolder(t,o,e)})))),n;if(t.children.some((e=>e.isUiFolder())))return this.moveError("course.outline.lmMoveFolderError"),n.$then((()=>{e.originalElement.show()}))}return n.$then((()=>{this.doMoveItemFolder(t,o,e)}))},this.moveItem=e=>{const t=this._findNodeByIdFromParentNode(this.rootNode,e.dragContentId),o=this._findNodeByIdFromParentNode(this.rootNode,e.parentFolderId);if(t.isLearningModule()&&0!==o.depth)return this.moveError("course.outline.lmMoveError"),this.$q.resolve();if(t.isUiFolder()&&l.p.ContentHandler.LearningModule.isEqualTo(o.contentHandler)){if(!t.children)return t.getChildren({limit:0}).$asPromise().then((n=>{if(!n.some((e=>e.isUiFolder())))return this.doMoveItem(t,o,e).then((()=>{}));this.moveError("course.outline.lmMoveFolderError")}));if(t.children.some((e=>e.isUiFolder())))return this.moveError("course.outline.lmMoveFolderError"),this.$q.resolve()}return this.doMoveItem(t,o,e).then((()=>{}))},this.onFileDropHandler=(e,t)=>{this.folders=[],t||(t=this.rootNode),this.dropTarget=t,this.dropTargetAssignedFromButton=!1,this.dropTargetInsertLocation=null},this.createFileContent=(e,t,o,n,r)=>{const{Folder:s,LearningModule:d}=l.p.ContentHandler,a=e&&(s.isEqualTo(e.contentHandler)||d.isEqualTo(e.contentHandler)),c=null!=r?r:this.calculateFileInsertLocation(e,a,n);if(null!=c){let n;return this.allyService.fileUploadEvent(),Object(h.a)(this.contentService.makeContentInContentTree(this.rootNode,this.contextCourse.courseId,c.parentId,c.positionBefore,c.positionAfter,!0).then((r=>(n=r.content,this.fillInDetailsForUploadedContent(n,c),n.ui.fileUploadId="fileUpload-"+Math.floor(1e4*Math.random())+"-"+Math.floor(1e4*Math.random()),n.ui.uploadCorrelationId=o,n.contentHandler=l.p.ContentHandler.File,null!=t&&(n.ui.file=t),a&&!e.ui.isOpen&&n.parentId===e.id&&this.toggleFolder(e),this.$scope.$root.$broadcast(i.e,o,n,i.c.ContentCreated),n))))}return Promise.resolve(void 0)},this.contextArea=a,"SKIP_LOAD_MORE_CHILDREN"!==this.contextArea&&this.contextArea!==u.a.ContentSearch?(this.$scope.course&&(this.canMove=this.entitlementService.isEntitled(p.f.ModifyContent),this.setRootNodeFromService(!1)),this.lastRootLoad=this._loadMoreChildren(this.rootNode),this.initialLoadPromise=this.lastRootLoad.$asPromise()):this.lastRootLoad=this.CourseContentModel.$collection(),this.setDeleteContentEventResponder(),Object(r.e)(this.$scope,((e,t,o)=>{t===this.contextCourse.courseId&&this.rootNodeType===o&&this.setRootNodeFromService(!0)})),e.$on("content-item-mouseover",((t,o)=>{e.$apply((()=>{e.$broadcast("content-item-hover",o)}))})),e.$on("content-outline-mouse-leave",(()=>{e.$broadcast("content-outline-hover-end")})),e.$on("scorm-content-canceled",((e,t)=>{this.cachedNode=this.rootNode.findInTreeById(t.parentId,this.cachedNode),this.deleteNode(t,this.cachedNode,!1)})),e.$on(i.e,((e,t,o,n)=>{n===i.c.Folder&&this.folderUpload(t,o)})),e.$on(i.e,((e,t,o,n)=>{if(n===i.c.File)if(o.path){const e=this.interval((()=>{const n=this.findFolder(o.path,this.folders,o.path.split("/").length-1);null!=n&&n.id&&(this.createFileContent(n,o,t,!0),this.interval.cancel(e))}),this.$scope,1e3,10)}else this.createFileContent(this.dropTarget,o,t,!1)})),e.$on(i.e,((e,t,o,n,r,s,d,l)=>{l===i.c.AssignDropTarget&&this.assignDropTarget(t,o,n,r,s,d)})),e.$on(i.e,((e,t,o)=>{o===i.c.AssignDropTarget&&t===this.syllabusKey&&this.assignDropTarget(this.rootNode.id,"start",void 0,1,t,void 0)})),e.$on(i.e,((e,t,o)=>{o===i.c.DeleteContent&&this.$scope.$root.$broadcast("deleteContent",t)})),e.$on(i.e,((t,o,n,r,s)=>{(r===i.c.Error||r===i.c.Cancel)&&n&&n.content&&e.$root.$broadcast("deleteContent",n.content)})),e.$on(i.e,((t,o,n,r,s,d,l)=>{s===i.c.Uploaded&&(this.populateContentFileDetails(r,n),this.populateContentFileSpecificDetails(r,n,l).then((e=>{e.$pk?(n.ui.isUploading=!1,n.isAvailable=!1):e.$save().$then((e=>{e.ui.isUploading=!1,e.isAvailable=!1}))}),(()=>{e.$root.$broadcast("deleteContent",n)})))})),e.$on(i.e,((e,t)=>{})),this.subscribeToRedux()}subscribeToRedux(){const e=this.$ngRedux.connect(null,(e=>({deleteContentInStore:t=>e(a.X.content.deleteContentInStore(t)),moveContentInStore:(t,o,n)=>e(a.X.content.moveContentInStore(t,o,n))})))(this);this.$scope.$on("$destroy",e)}loadRootChildren(e,t){e.cancelGetChildren();const o=this.$q.defer();return this.lastRootLoad.$always((()=>(this.hasNetworkError=!1,this.lastRootLoad=this.loadMoreChildren(e,t).$then((e=>{o.resolve(e)}),(e=>{this.contentLoadInProgress=!1,"error"===(null==e?void 0:e.$status)&&"abort"!==(null==e?void 0:e.$response.xhrStatus)&&(this.hasNetworkError=!0),o.reject(e)})).$finally((()=>{this.lastRootLoad=this.CourseContentModel.$collection(),this.recalculateEmptyState()})),this.lastRootLoad))),o.promise}searchByCriteria(e,t,o,n,i,r){return this.searchParameters={title:t,contentSearchMode:o,sort:n},r?this.loadSingleContent(r).$asPromise():this.loadRootChildren(e,i)}setRootNodeFromService(e){const t=e?this.rootNode.children:null;this.rootNode=this.contentService.findRootNode(this.$scope.course.model,this.rootNodeType),this.rootNode.depth=0,this.rootNode.title=this.rootNodeType.toString(),this.rootNode.contentHandler=l.p.ContentHandler.Folder,this.rootNode.hasMoreChildren=!0,this.rootNode.children=t}_loadMoreChildren(e,t=!0){const o=this._loadMoreChildrenImp(e);return this.$scope.$root&&o.$promise&&t&&this.$scope.$root.$broadcast(d.a,"content-outline-"+e.id,o.$promise),o.$then((()=>{e===this.rootNode&&this.recalculateEmptyState(),this.contentService.fetchIndicators(this.contextCourse.courseId).then((t=>{this.updateIndicators(t,e)}))})),o}updateIndicators(e,t){t||(t=this.rootNode),e&&e.forEach((e=>{t.children.forEach((t=>{l.p.ContentHandler.Discussion.isEqualTo(t.contentHandler)?(t.assignedGroups&&e.groupIds&&-1!==e.groupIds.indexOf(t.assignedGroups[0].groupId)||t.contentDetail[l.p.ContentHandler.Discussion.toString()].id===e.forumId)&&(t.ui.hasIndicator=e.newData):t.id===e.contentId&&(t.ui.hasIndicator=e.newData)}))}))}dismissContentIndicators(e,t){const o=this.rootNode.findInTreeById(e);if(o)o.ui.hasIndicator=!1;else{const e=this.rootNode.findInTreeById(t);e&&(e.ui.hasIndicator=!1)}}recalculateEmptyState(){this.isEmpty=null==this.rootNode.children||0===this.rootNode.children.length}populateContentFileDetails(e,t){t.title=decodeURIComponent(e.fileName),t.contentHandler=l.p.ContentHandler.File,t.contentDetail={"resource/x-bb-file":{file:{fileName:e.fileName,fileLocation:e.fileLocation},fileAssociationMode:c.G.Embed}}}populateContentFileSpecificDetails(e,t,o){return t.$asPromise()}setDeleteContentEventResponder(){this.$scope.$on("deleteContent",((e,t,o=!0)=>{this.deleteContentItem(t,o)}))}deleteCourseLinks(e,t){var o;null===(o=e.children)||void 0===o||o.filter((e=>this.isCourseContentLinkWithLinkSourceId(e,t.id))).forEach((t=>this.deleteNode(t,e,!1)))}isCourseContentLinkWithLinkSourceId(e,t){if(!e.contentDetail)return!1;const o=e.contentDetail[e.contentHandler.toString()];return!!o&&(e.isCourseLink()&&o.linkSourceId===t)}handleCourseLinksInOutline(e,t){var o;null===(o=t.children)||void 0===o||o.filter((e=>e.isFolder()||e.isLearningModule())).forEach((t=>{t.children&&t.children.filter((e=>e.isFolder()||e.isLearningModule())).length>0?this.handleCourseLinksInOutline(e,t):this.deleteCourseLinks(t,e)})),this.deleteCourseLinks(t,e)}deleteNode(e,t,o=!0){if(!e.ui.isDeleted){let n=this.$q.when();o&&(n=this.deleteContent(e).then((()=>{this.deleteContentInStore(e.id)}))),n.then((()=>{this.removeNodeFromOutline(e,t)}))}}removeNodeFromOutline(e,t){if(t&&t.children){let o;if(null==e.id&&l.p.ContentHandler.File.isEqualTo(e.contentHandler)&&e.ui.isUploading){const n=t.children.filter((t=>t.ui.fileUploadId===e.ui.fileUploadId))[0];o=t.children.indexOf(n)}else o=t.children.indexOfItemById(e.id);o>=0&&(t.children.splice(o,1),t.children.paging&&t.children.paging.count--,this.updateDeleteFocus(o,t))}}updateDeleteFocus(e,t){if(t.children&&t.children.length){const o=t.children[e===t.children.length?e-1:e].id;this.accessibility.setFocusOverrideOnPanel("[data-content-id="+o+"] .content-title",".js-content-outline, .js-engagement-outline")}else t.parentId?this.accessibility.setFocusOverrideOnPanel("[data-content-id="+t.id+"] .content-title",".js-content-outline, .js-engagement-outline"):this.accessibility.setFocusOverrideOnPanel(".bb-close",".bb-offcanvas-panel-wrap")}deleteContent(e){return this.contentService.deleteContent(e)}_findNodeByIdFromParentNode(e,t){return e.findLoadedNodeById(t,3)}_loadMoreChildrenImp(e){var t,o;let n;if(null==e.hasMoreChildren&&(e.hasMoreChildren=!0),e.ui.isUploading&&(e.hasMoreChildren=!1),!e.hasMoreChildren)return this.CourseContentModel.$collection();{if(this.contentLoadInProgress)return null!=e.children?e.children:this.CourseContentModel.$collection();this.contentLoadInProgress=!0;const i=null!==(o=null===(t=this.ultraState.params)||void 0===t?void 0:t.search)&&void 0!==o?o:"";""!==i&&(this.searchParameters={title:i,contentSearchMode:c.cb.courseContent,sort:c.bc.MODIFIED_DATE_DESC});const r=null==e.children?0:e.children.length,s="ROOT"===e.$pk&&this.searchParameters?this.searchParameters:null;null==e.children?(n=e.children=e.getChildren({limit:this.CONTENT_LOADING_LIMIT,resolveLinks:!0,expand:"assignedGroups,selfEnrollmentGroups.group",...s}),e.children.$then((()=>{this._determineHasMoreChildren(e,r),this.contentLoadInProgress=!1,this.replaceDueDate(e.children)}))):n=e.getChildren({offset:e.children.length,limit:this.CONTENT_LOADING_LIMIT,resolveLinks:!0,expand:"assignedGroups,selfEnrollmentGroups.group",...s}).$then((t=>{t.forEach((t=>{t.$scope=e.children,e.children.push(t)})),e.children.paging=t.paging,this._determineHasMoreChildren(e,r),this.contentLoadInProgress=!1,this.replaceDueDate(t)}))}return n}replaceDueDate(e){var t;if(!(null===(t=this.$scope.course.membership)||void 0===t?void 0:t.isStudentMembership()))return;const o=e.filter((e=>a.i.TestLink.isEqualTo(e.contentHandler)));if(0===o.length)return;const n=this.contextCourse.courseId,i=this.$scope.course.membership.id,r=o.map((e=>e.getAssociatedGradingColumn().id));this.gradableItemUserOptionService.getGradableItemUserOptionExceptions(n,i,r).then((e=>{o.forEach((t=>{var o;const n=null===(o=t.getAssociatedGradingColumn())||void 0===o?void 0:o.id;e.byColumnId[n]&&(t.genericReadOnlyData.dueDate=null!=e.byColumnId[n].effectiveDueDate?new Date(e.byColumnId[n].effectiveDueDate).toISOString():null)}))}))}_determineHasMoreChildren(e,t){e.children.length-t<this.CONTENT_LOADING_LIMIT&&(e.hasMoreChildren=!1)}folderUpload(e,t){let o,i=!0,r={parentId:"",positionBefore:void 0,positionAfter:void 0,depth:0};const d=!t.path||t.name===t.path;let a;const h=this.interval((()=>{d?this.dropTargetInsertLocation?r=this.calculateAddContentButtonInsertLocation():(a=l.p.ContentHandler.Folder.isEqualTo(this.dropTarget.contentHandler),a?this.dropTarget.depth<s.l?(r.depth=this.dropTarget.depth+1,r.parentId=this.dropTarget.id):(r.depth=s.l,r.parentId=this.dropTarget.parentId):(r.parentId=this.dropTarget.parentId,r.depth=this.dropTarget.depth)):(o=this.findFolder(t.path,this.folders,t.path.split("/").length-1),o&&(o.depth<s.l?(r.depth=o.depth+1,r.parentId=o.$pk):(r.depth=s.l,r.parentId=o.parentId)));const e=this.rootNode.findInTreeById(r.parentId);if(""!==r.parentId&&e){if(i=!0,n.isUndefined(o)){let e;if(!this.dropTarget&&this.dropTargetInsertLocation){const t=this.$scope.course.model.contents.$new(this.addContentButtonContentId);a=l.p.ContentHandler.Folder.isEqualTo(t.contentHandler),e=this.finalizeMultiLevelFolderInsertLocation(t,r,a,i),r=e.insertLocation,i=e.keepGoing}else e=this.finalizeMultiLevelFolderInsertLocation(this.dropTarget,r,a,i),r=e.insertLocation,i=e.keepGoing}else if(n.isUndefined(o.children))r.positionAfter="end";else{const e=o.children[o.children.length-1];e.id?r.positionAfter=e.id:i=!1}i&&(this.completeFolderUpload(r,e,t),this.interval.cancel(h))}}),this.$scope,1e3,10)}finalizeMultiLevelFolderInsertLocation(e,t,o,i){const r={insertLocation:t,keepGoing:i};if(o)if(n.isUndefined(e.children))r.insertLocation.positionBefore="start";else if(e.children.length>0){const t=e.children[this.dropTarget.children.length-1];t.id?r.insertLocation.positionAfter=t.id:r.keepGoing=!1}else r.insertLocation.positionBefore="start";else null==t.positionBefore&&(r.insertLocation.positionAfter=e.id||e.$pk);return r}completeFolderUpload(e,t,o){this.allyService.fileUploadEvent();const n=this.interval((()=>{if(t.children)return this.interval.cancel(n),this.contentService.makeContentInContentTree(t,this.contextCourse.courseId,e.parentId,e.positionBefore,e.positionAfter,!0).then((t=>{const n=t.content;n.title=o.name,this.folders.push(n),this.fillInDetailsForUploadedContent(n,e),n.contentDetail={"resource/x-bb-folder":{isFolder:!0}},n.contentHandler=l.p.ContentHandler.Folder,n.$save().$then((e=>{e.ui.isUploading=!1}))}))}),this.$scope,100,10)}fillInDetailsForUploadedContent(e,t){e.parentId=t.parentId,e.positionBefore=t.positionBefore,e.positionAfter=t.positionAfter,e.isAvailable=!1,e.depth=t.depth,e.description="",e.courseId=this.contextCourse.courseId,e.ui.isUploading=!0}doMoveItemFolder(e,t,o){const n=this._findNodeByIdFromParentNode(this.rootNode,e.parentId);e.moveTo(t,"start",null),e.$patch().$then((()=>{n.children.paging.count--,t.children.paging.count++,this.moveContentInStore(o.dragContentId,o.targetFolderId,e.position)})),o.originalElement.show()}moveError(e){}doMoveItem(e,t,o){const n=this._findNodeByIdFromParentNode(this.rootNode,e.parentId);return t!==n&&(t.children.paging.count++,n.children.paging.count--),e.moveTo(t,o.positionBeforeId,o.positionAfterId),e.$patch().$then((()=>{this.moveContentInStore(o.dragContentId,o.parentFolderId,e.position)})).$asPromise()}assignDropTarget(e,t,o,n,i,r){this.dropTargetInsertLocation={parentId:e,positionBefore:t,positionAfter:o,depth:n},this.dropTargetAssignedFromButton=!0,this.addContentButtonContentId=r?r.id:"ROOT",this.folders=[]}canCreateDiscussion(){return this.canCreateAllContent()||this.canOnlyCreateDiscussion()}canOnlyCreateDiscussion(){return this.contentService.canOnlyCreateDiscussion(this.rootNode)}canCreateAllContent(){return this.contentService.canCreateAllContent(this.rootNode)}calculateAddContentButtonInsertLocation(){const e={parentId:"",positionBefore:void 0,positionAfter:void 0,depth:0};return e.parentId=this.dropTargetInsertLocation.parentId,e.positionBefore=this.dropTargetInsertLocation.positionBefore,e.positionAfter=this.dropTargetInsertLocation.positionAfter,e.depth=this.dropTargetInsertLocation.depth,e}getIdOfLastPersistedChild(e){if(null==e.children||0===e.children.length)return null;let t=e.children.length-1,o=e.children[t].id;for(;null==o&&t>=0;)o=e.children[t].id,t--;return o}calculateFileDNDInsertLocation(e,t,o){if(o){e.parentId=t.id,e.depth=t.depth+1;const o=this.getIdOfLastPersistedChild(t);o?e.positionAfter=o:e.positionBefore="start"}else e.parentId=t.parentId,e.depth=t.depth,e.positionAfter=t.id;return e}calculateFileInsertLocation(e,t,o){const n={parentId:"",positionBefore:void 0,positionAfter:void 0,depth:0};return this.dropTargetInsertLocation&&!o?this.calculateAddContentButtonInsertLocation():this.calculateFileDNDInsertLocation(n,e,t)}findFolder(e,t,o){if(--o>=0){const n=e.split("/")[o],i=t.filter((e=>e.title===n));if(1===i.length)return i[0];if(i.length>0)return this.findFolder(e,i,o)}}toggleFolder(e){this.$scope.$root.$broadcast("toggle-folder",e)}}class f extends I{}}}]);