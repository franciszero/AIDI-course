(window.webpackJsonp=window.webpackJsonp||[]).push([[22],{"7pcG":function(e,t,r){"use strict";r.d(t,"a",(function(){return N})),r.d(t,"b",(function(){return D}));var n=r("Llzl"),s=r("ZQFV"),a=r("0JpG"),o=r("fYJU"),l=r("go4a"),i=r("VdDF"),u=r("jhBu"),c=r("Sa5G"),d=r("P2dS"),h=r("pjml"),m=r("wgY5"),f=r("8jzW"),p=r("TnpK"),y=r("vhkR"),I=r("RPob"),v=r("9hUw"),C=r("Is+C"),g=r("z6Q5"),S=r("zGdY"),R=r("IbyE"),b=r("V0gA");const N="ultra.components.services.calendar",D="bbCalendar";var E;!function(e){e.Institution="Institution",e.Personal="Personal",e.Course="Course",e.ExternalCourse="ExternalCourse",e.OfficeHoursForAllCourses="OfficeHoursForAllCourses"}(E||(E={}));class M{constructor(e,t,r,n,s,a,o,l,i,u,c,d,h,m,f,p){this.$q=e,this.batchService=t,this.localize=r,this.contextUser=n,this.CourseModel=s,this.CourseMembershipModel=a,this.ExternalCourseModel=o,this.InstitutionCalendarItemModel=l,this.UserModel=i,this.entitlementService=u,this.categoryService=c,this.scoreProviderHelper=d,this.ultraState=h,this.ltiService=m,this.peerReview=f,this.scormService=p}mixinColorIndexToCalendarItems(e,t){const r={};e.forEach((e=>{const t=e.calendarId;(r[t]=r[t]||[]).push(e)}));const n=r[S.U.Institution];n&&n.forEach((e=>{e.ui.courseColorClass="institution-color"}));const s=r[S.U.Personal];s&&s.forEach((e=>{e.ui.courseColorClass="personal-color"}));const a=[];return this.batchService.performBatch((()=>{Object.keys(r).filter((e=>!Object.values(S.U).includes(e))).forEach((e=>{a.push(this.CourseModel.$new(e).users.$find(t).$asPromise())}))})),this.$q.all(a).then((e=>{e.forEach((e=>{const t=r[e.course.$pk];if(!t)return;const n=l.a(e);t.forEach((e=>{e.ui.courseColorClass=n}))}))})).then((()=>e))}updateCalendarItemTime(e,t,r){const n=this.getCalendarItem({calendarId:e.calendarId,itemSourceId:e.itemSourceId,itemSourceType:e.itemSourceType,recurRules:{repeatRuleType:e.recurRules&&e.recurRules.repeatRuleType,repeatRuleCourseId:e.recurRules&&e.recurRules.repeatRuleCourseId,repeatRuleUserId:e.recurRules&&e.recurRules.repeatRuleUserId},startDate:t,endDate:r});e.recurRules&&e.recurRules.repeatRuleType?(n.startDate=new Date(t.getTime()-e.startDate.getTime()+e.recurRules.originalStart.getTime()),n.endDate=new Date(r.getTime()-e.endDate.getTime()+e.recurRules.originalEnd.getTime())):(n.startDate=t,n.endDate=r);const s=["startDate","endDate"];return e.recurRules&&(n.recurRules={...e.recurRules,count:e.recurRules.count>=0?e.recurRules.count:null,originalStart:n.startDate,originalEnd:n.endDate,timeZoneId:i.a.getCurrentTimeZoneId()},Object.keys(n.recurRules).forEach((e=>{s.push(`recurRules.${e}`)}))),n.$save(s).$asPromise()}findCalendarItem(e){return this.getCalendarItem(e).$fetch().$asPromise()}getCalendarItem(e){var t,r;const n={itemSourceId:e.itemSourceId,itemSourceType:e.itemSourceType};return e.calendarId===S.U.Institution?this.InstitutionCalendarItemModel.$new(n):S.q.OfficeHours===(null===(t=e.recurRules)||void 0===t?void 0:t.repeatRuleType)?this.CourseModel.$new(e.recurRules.repeatRuleCourseId).users.$new(e.recurRules.repeatRuleUserId).officeHours.$new(n):e.calendarId===S.U.Personal?this.UserModel.$new(this.contextUser.userId).calendarItems.$new(n):S.q.ClassSchedule===(null===(r=e.recurRules)||void 0===r?void 0:r.repeatRuleType)?this.CourseModel.$new(e.calendarId).schedule.$new(n):this.CourseModel.$new(e.calendarId).calendars.calendarItems.$new(n)}getNextEventForDailyRepeat(e,t){if(!e||S.r.Daily!==e.freq)return null;let r=e.interval;if(null==r&&(r=1),Number.isNaN(Number(r))||r!==Math.floor(r)||r<1||r>100)return null;const n=m(e.originalStart);let s=m(t);s.hours(n.hours()).minutes(n.minutes()).seconds(n.seconds()).milliseconds(n.milliseconds());const a=s.diff(n,"days");let o=Math.floor(a/r);a<=0?s=n:o*r!==a&&(s.add({days:(o+1)*r-a}),o++),o++;let l=!1;if(e.endsBy)l=e.until&&s.isBefore(e.until);else{const t=e.count;t>0&&t===Math.floor(t)&&(l=o<=e.count)}return l?s.toDate():null}getNextEventForWeeklyRepeat(e,t){var r;if(!e||S.r.Weekly!==e.freq)return null;const n=null!==(r=e.interval)&&void 0!==r?r:1;if(Number.isNaN(Number(n))||n!==Math.floor(n)||n<1||n>100)return null;const s=m(e.originalStart),a=m(t);a.hours(s.hours()).minutes(s.minutes()).seconds(s.seconds()).milliseconds(s.milliseconds());const o=m(e.until),l=e.byWeekDay;let i=[],u=!1;l&&l.forEach((t=>{const r=m(s.days(t).toDate());a.diff(r,"days")<=0?i.push(s.toDate()):this.getNextEventDatesForWeeklyInterval(r,e,i)})),i=i.sort(((e,t)=>e.valueOf()-t.valueOf()));const c=i.find((e=>m(e)>=a));if(e.endsBy)u=e.until&&m(c)<o;else{const t=e.count;t>0&&t===Math.floor(t)&&l&&(u=l.length<=t)}return u?c:null}getNextEventDatesForWeeklyInterval(e,t,r){if(r.push(e.toDate()),t.endsBy)for(;e.add({days:7*t.interval})<m(t.until);)r.push(e.toDate());else for(let n=1;n<t.count;n++)e.add({days:7*t.interval}),r.push(e.toDate())}getNextEventForMonthlyRepeat(e,t){if(!e||S.r.Monthly!==e.freq)return null;const r=e.monthRepeatBy?this.getNextEventForByMonthDayRepeat(e,t):this.getNextEventForBySetPosRepeat(e,t);if(!r)return null;const n=e.monthRepeatBy?this.getNextEventForByMonthDayRepeat(e,e.originalStart):this.getNextEventForBySetPosRepeat(e,e.originalStart);if(!n)return null;let s=!1;if(e.endsBy)s=e.until&&r.isBefore(e.until);else{const t=e.count;let a=e.interval;if(null==a&&(a=1),Number.isNaN(Number(a))||a!==Math.floor(a)||a<1||a>100)return null;t>0&&t===Math.floor(t)&&(s=e.monthRepeatBy&&e.byMonthDay>28?this.isWithinOccurrences(n,r,e.byMonthDay,t,a):r.diff(n,"months")<(t-1)*a+1)}return s?r.toDate():null}getNextEventForByMonthDayRepeat(e,t){const r=e.byMonthDay;if(Number.isNaN(Number(r))||r!==Math.floor(r)||r<=0||r>31)return null;const n=e.interval||1;if(Number.isNaN(Number(n))||n!==Math.floor(n))return null;const s=m(e.originalStart);let a=m(t);a.hours(s.hours()).minutes(s.minutes()).seconds(s.seconds()).milliseconds(s.milliseconds());const o=a.date();a.date(1),o>r&&a.add({months:1});const l=s.clone().date(1),i=a.diff(l,"months"),u=Math.floor(i/n);i<=0?a=s:i!==n*u&&a.add({months:(u+1)*n-i});for(let e=0;e<6;e++){if(a.clone().endOf("month").date()>=r)return a.date(r);a.add({months:n})}return null}getNextEventForBySetPosRepeat(e,t){const r=Object(b.parseWeekDay)(e.byDay),n=e.bySetPos;if(!r||Number.isNaN(Number(n))||n!==Math.floor(n)||0===n||n<-1||n>4)return null;const s=m(e.originalStart),a=m(t),o=a.date();let l,i;return a.date(1).hours(s.hours()).minutes(s.minutes()).seconds(s.seconds()).milliseconds(s.milliseconds()),n>0?(l=a.day(),i=Object(b.getDayOfWeek)(r)-l,i<0&&(i+=7),i+=7*(n-1),a.add({days:i})):(a.add({months:1}),l=a.day(),i=Object(b.getDayOfWeek)(r)-l,i>=0&&(i-=7),a.add({days:i})),a.date()>=o?a:this.getNextEventForBySetPosRepeat(e,a.date(1).add({months:1}).toDate())}isWithinOccurrences(e,t,r,n,s){if(e.isSame(t,"day")&&n>=1)return!0;let a=1;const o=e.clone().date(1);for(;a<n;){if(o.add({months:s}).endOf("month"),o.date()>=r&&(a++,o.date(r),!o.isBefore(t,"day")))return!0;o.date(1)}return!1}getSampleDateForDayOfWeek(e){return Number.isNaN(Number(e))||e!==Math.floor(e)||e<0||e>6?null:new Date(2015,3,5+e)}mixinMetadataToCalendarItems(e,t){const r={};e.forEach((e=>{let t;t=e.calendarId===S.U.Personal?e.recurRules&&S.q.OfficeHours===e.recurRules.repeatRuleType?E.OfficeHoursForAllCourses:e.recurRules&&S.q.ExternalCourseSchedule===e.recurRules.repeatRuleType?E.ExternalCourse:E.Personal:e.calendarId===S.U.Institution?E.Institution:E.Course,r[t]=r[t]||[],r[t].push(e)}));const n=[];n.push(this.localize.loadBundle("components/services/calendar").then((()=>{const e=r[E.OfficeHoursForAllCourses];e&&e.forEach((e=>{e.ui.calendarName=this.localize.translateSync({locale:t,key:"components.services.calendar.allCourses"})}));const n=r[E.Personal];n&&n.forEach((e=>{e.ui.calendarName=this.localize.translateSync({locale:t,key:"components.services.calendar.personal"})}));const s=r[E.Institution];s&&s.forEach((e=>{e.ui.calendarName=this.localize.translateSync({locale:t,key:"components.services.calendar.institution"})}))})));const s=r[E.Course];s&&s.forEach((e=>{e.calendarNameLocalizable&&e.calendarNameLocalizable.rawValue&&(e.ui.calendarName=e.calendarNameLocalizable.rawValue,e.ui.linkType=h.g.MetadataOnCalendarItemCardLinkType.Course)}));const a=r[E.ExternalCourse];return a&&n.push(this.batchService.performBatch((()=>this.$q.all(a.map((e=>this.ExternalCourseModel.$new(e.recurRules.repeatRuleExternalCourseId).$fetch().$asPromise()))))).then((e=>{e.forEach((e=>{a.forEach((t=>{t.ui.calendarName=e.title,t.ui.linkType=h.g.MetadataOnCalendarItemCardLinkType.External,t.ui.externalCourseUrl=e.url}))}))}))),this.$q.all(n)}calculateDateToPersist(e,t,r){if(e&&m(t).isSame(r,"day"))return t;if(e){const e=m(r).clone().toDate();return e.setHours(t.getHours(),t.getMinutes(),t.getSeconds(),t.getMilliseconds()),e}return r}viewDueCalendarItem(e){e&&e.isDueItem()&&this.CourseModel.$new(e.calendarId).$fetch().$then((t=>{var r;if(t.isUltra())t.gradebook.columns.$new(e.itemSourceId).$fetch({expand:"collectExternalSubmissions"}).$then((e=>{if(e.isOffline())this.entitlementService.hasCourseEntitlement(s.q.ModifyGradebook,t.id).then((r=>{r&&this.ultraState.goPeekState("gradebook-item.offline",{columnId:e.id,courseId:t.id,gradeitemView:"students"})}));else{const r=R.Q.parse(e.scoreProviderHandle.toString());if(r){const n=r.getContentHandlers()[0];this.ltiService.isLTILink(e)?this.ltiService.ltiLaunch({courseId:e.courseId,contentId:e.contentId,linkType:c.g.parse(e.scoreProviderHandle.toString()),linkRefId:e.linkId}):e.isScorm()?this.scormService.scormLaunch({courseId:e.courseId,contentId:e.contentId,showPreLaunchPanel:!0}):this.scoreProviderHelper.openStateRef(n,{isCollectExternalSubmissions:e.isCollectExternalSubmissions(),contentId:e.contentId,courseId:t.id},f.a.GoToState)}}}));else{const n=e.permissions&&e.permissions.edit;(n||(null===(r=e.dynamicCalendarItemProps)||void 0===r?void 0:r.attemptable))&&this.ultraState.goPeekState("course.outline",{courseId:t.id,legacyUrl:n?"/webapps/calendar/launch/modify/_"+e.itemSourceType+"-"+e.itemSourceId:"/webapps/calendar/launch/attempt/_"+e.itemSourceType+"-"+e.itemSourceId})}}))}getCustomItemIcon(e){return Object(I.f)(e.customIconUrl)}getCalendarItemIcon(e){if(!e.dynamicCalendarItemProps)return this.$q.when("");const{categoryId:t,handle:r}=e.dynamicCalendarItemProps;return this.categoryService.getOrLoadCategoriesForCourse(e.calendarId).then((e=>{let n="";if(r===h.p.ContentHandler.LtiLink.handle)n=h.p.ContentHandler.LtiLink.iconClass.replace("img-icon-","");else{const s=e.find((e=>e.id===t));s?n=this.categoryService.getCategoryIcon(s):r&&(n=R.Q.parse(r).iconClass)}return this.$q.when(n)}))}getCalendarItemTitle(e,t){var r;return this.peerReview.isPeerEvaluationItem(null===(r=null==e?void 0:e.dynamicCalendarItemProps)||void 0===r?void 0:r.handle)?this.peerReview.wrapPeerEvaluationItemTitle(e.title,t):null==e?void 0:e.title}}M.$inject=["$q",g.b,a.serviceName,o.b,h.m.serviceName,h.t.serviceName,h.z.serviceName,h.H.serviceName,h.Jb.serviceName,u.b,d.c,f.c,p.d,y.b,v.b,C.c];n.module(N,[g.a,a.moduleName,o.a,h.N,d.b,f.b,p.b,y.a,v.a,C.b]).service(D,M)}}]);